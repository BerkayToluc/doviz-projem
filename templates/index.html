<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>MBT Finans Terminali</title>
    <link rel="icon" href="{{ url_for('static', filename='icon.png') }}" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/css/flag-icons.min.css"/>
    <style>
        body { background-color: #000000; color: #FFFFFF; font-family: 'Segoe UI', sans-serif; }
        .card { background-color: #121212; border: 1px solid #333; border-radius: 15px; margin-bottom: 20px; }
        .text-bright { color: #FFFFFF !important; font-weight: 600; }

        .price-tag {
            font-size: 1.6rem;
            font-weight: bold;
            color: #FFFFFF;
            transition: color 0.5s ease, text-shadow 0.5s ease;
        }

        .price-up { color: #00FF41 !important; text-shadow: 0 0 10px #00FF41; }
        .price-down { color: #FF3131 !important; text-shadow: 0 0 10px #FF3131; }

        .header-title { color: #FFD700; text-transform: uppercase; letter-spacing: 2px; border-bottom: 2px solid #FFD700; display: inline-block; padding-bottom: 5px; }

        .update-flash { animation: flash-animation 1s; }
        @keyframes flash-animation {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .loading-text { font-size: 1rem; color: #888888; font-weight: 400; font-style: italic; }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <div class="text-center mb-5">
            <h1 class="header-title d-inline-flex align-items-center pb-2">
                <img src="{{ url_for('static', filename='icon.png') }}" alt="MBT Logo" style="width: 60px; height: 60px; margin-right: 15px; border-radius: 8px;">
                MBT Finans Terminali
            </h1>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card p-4 shadow">
                    <h3 class="text-bright mb-3">üí± D√∂viz Hesapla</h3>
                    <input type="number" id="calc-miktar" class="form-control mb-3 bg-dark text-white border-secondary" placeholder="Miktar Giriniz">
                    <select id="calc-birim" class="form-select mb-3 bg-dark text-white border-secondary">
                        <option value="USD">Dolar (USD)</option>
                        <option value="EUR">Euro (EUR)</option>
                        <option value="GBP">Sterlin (GBP)</option>
                        <option value="CHF">ƒ∞svi√ßre Frangƒ± (CHF)</option>
                        <option value="JPY">Japon Yeni (JPY)</option>
                        <option value="PLN">Polonya Zlotisi (PLN)</option>
                    </select>
                    <button type="button" class="btn btn-primary w-100 fw-bold" onclick="calcDoviz()">TL'YE √áEVƒ∞R</button>
                    <div id="doviz-sonuc-box" class="alert alert-info mt-3 bg-primary text-white border-0" style="display:none;">
                        <span id="doviz-sonuc-text"></span>
                    </div>
                </div>

                <div class="card p-4 shadow">
                    <h3 class="text-bright mb-3 text-warning">‚ú® Altƒ±n Hesapla</h3>
                    <input type="number" id="calc-altin-miktar" class="form-control mb-3 bg-dark text-white border-secondary" placeholder="Adet veya Gram">
                    <select id="calc-altin-turu" class="form-select mb-3 bg-dark text-white border-secondary">
                        <option value="GRAM">Gram Altƒ±n</option>
                        <option value="CEYREK">√áeyrek Altƒ±n</option>
                        <option value="YARIM">Yarƒ±m Altƒ±n</option>
                        <option value="TAM">Tam Altƒ±n</option>
                        <option value="CUMHURIYET">Cumhuriyet Altƒ±nƒ±</option>
                        <option value="ATA">Ata Altƒ±nƒ±</option>
                    </select>
                    <button type="button" class="btn btn-warning w-100 fw-bold" onclick="calcAltin()">HESAPLA</button>
                    <div id="altin-sonuc-box" class="alert alert-warning mt-3 bg-warning text-dark border-0" style="display:none;">
                        <span id="altin-sonuc-text"></span>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
               <h3 class="text-bright mb-3">üìà Canlƒ± Piyasa Verileri</h3>

                {% for kod, isim, bayrak in [('USD','USD / TRY','us'), ('EUR','EUR / TRY','eu'), ('GBP','GBP / TRY','gb'), ('CHF','CHF / TRY','ch'), ('JPY','JPY / TRY','jp'), ('PLN','PLN / TRY','pl')] %}
                <div class="card p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-bright fs-5"><span class="fi fi-{{bayrak}} me-2"></span> {{isim}}</span>
                        <span class="price-tag" id="val-{{kod}}">
                            {% if kurlar.get(kod) %}{{ kurlar.get(kod) }} ‚Ç∫{% else %}<span class="loading-text">‚è≥ Baƒülanƒ±yor...</span>{% endif %}
                        </span>
                    </div>
                </div>
                {% endfor %}

                <div class="card p-3 border-warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-warning fs-5">üèÜ Gram Altƒ±n</span>
                        <span class="price-tag" id="val-GRAM">
                            {% if altin_fiyatlari.get('GRAM') %}{{ altin_fiyatlari.get('GRAM') }} ‚Ç∫{% else %}<span class="loading-text">‚è≥ Baƒülanƒ±yor...</span>{% endif %}
                        </span>
                    </div>
                </div>

                <div class="card p-3 border-info">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-info fs-5">üåç Ons Altƒ±n (XAU)</span>
                        <span class="price-tag" id="val-ONS">
                            {% if altin_fiyatlari.get('ONS') %}${{ altin_fiyatlari.get('ONS') }}{% else %}<span class="loading-text">‚è≥ Baƒülanƒ±yor...</span>{% endif %}
                        </span>
                    </div>
                </div>

                <div class="card p-3" style="border: 1px solid #C0C0C0;">
                    <div class="d-flex justify-content-between align-items-center">
                        <span style="color: #C0C0C0;" class="fs-5">ü•à Ons G√ºm√º≈ü (XAG)</span>
                        <span class="price-tag" id="val-ONS-GUMUS">
                            {% if altin_fiyatlari.get('ONS-GUMUS') %}${{ altin_fiyatlari.get('ONS-GUMUS') }}{% else %}<span class="loading-text">‚è≥ Baƒülanƒ±yor...</span>{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-12">
                <div class="card p-4 shadow border-secondary">
                    <h3 class="text-bright mb-3">üìä Canlƒ± Piyasa Grafikleri</h3>

                    <div class="tradingview-widget-container">
                        <div class="tradingview-widget-container__widget"></div>
                        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js" async>
                        {
                        "symbols": [
                            [
                            "Dolar / TL",
                            "FX_IDC:USDTRY|1D"
                            ],
                            [
                            "Euro / TL",
                            "FX_IDC:EURTRY|1D"
                            ],
                            [
                            "Sterlin / TL",
                            "FX_IDC:GBPTRY|1D"
                            ],
                            [
                            "ƒ∞svi√ßre Frangƒ± / TL",
                            "FX_IDC:CHFTRY|1D"
                            ],
                            [
                            "Ons Altƒ±n ($)",
                            "OANDA:XAUUSD|1D"
                            ],
                            [
                            "Ons G√ºm√º≈ü ($)",
                            "OANDA:XAGUSD|1D"
                            ]
                        ],
                        "chartOnly": false,
                        "width": "100%",
                        "height": 400,
                        "locale": "tr",
                        "colorTheme": "dark",
                        "autosize": false,
                        "showVolume": false,
                        "showMA": false,
                        "hideDateRanges": false,
                        "hideMarketStatus": false,
                        "hideSymbolLogo": false,
                        "scalePosition": "right",
                        "scaleMode": "Normal",
                        "fontFamily": "Segoe UI, sans-serif",
                        "fontSize": "10",
                        "noTimeScale": false,
                        "valuesTracking": "1",
                        "changeMode": "price-and-percent",
                        "chartType": "area",
                        "maLineColor": "#2962FF",
                        "maLineWidth": 1,
                        "maLength": 9,
                        "lineWidth": 2,
                        "lineType": 0,
                        "dateRanges": [
                            "1d|1",
                            "1w|15",
                            "1m|30",
                            "3m|60",
                            "12m|1D",
                            "60m|1W",
                            "all|1M"
                        ]
                        }
                        </script>
                    </div>
                    </div>
            </div>
        </div>
        </div>

    <div id="gizli-depo" style="display: none;">
        <span id="val-CEYREK">{{ altin_fiyatlari.get('CEYREK', '0') }}</span>
        <span id="val-YARIM">{{ altin_fiyatlari.get('YARIM', '0') }}</span>
        <span id="val-TAM">{{ altin_fiyatlari.get('TAM', '0') }}</span>
        <span id="val-CUMHURIYET">{{ altin_fiyatlari.get('CUMHURIYET', '0') }}</span>
        <span id="val-ATA">{{ altin_fiyatlari.get('ATA', '0') }}</span>
    </div>

    <script>
        let eskiFiyatlar = {};

        function temizleVeSayiyaCevir(text) {
            if(!text || text === "0" || text === "---" || text.includes("Baƒülanƒ±yor")) return 0;

            let temiz = text.toString().replace(/[‚Ç∫$\s]/g, '').trim();
            if (temiz === "---" || temiz === "") return 0;

            let noktasiz = temiz.replace(/\./g, '');
            let sayiFormati = noktasiz.replace(',', '.');
            let sonuc = parseFloat(sayiFormati);
            return isNaN(sonuc) ? 0 : sonuc;
        }

        function calcDoviz() {
            let miktar = document.getElementById('calc-miktar').value;
            let birim = document.getElementById('calc-birim').value;
            let el = document.getElementById('val-' + birim);

            if (miktar && el) {
                let kur = temizleVeSayiyaCevir(el.textContent);
                if (kur === 0) {
                     alert("Piyasa verileri y√ºkleniyor, l√ºtfen 1-2 saniye bekleyip tekrar deneyin.");
                     return;
                }
                let sonuc = miktar * kur;
                document.getElementById('doviz-sonuc-text').innerText =
                    miktar + " " + birim + " = " +
                    sonuc.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " TL";
                document.getElementById('doviz-sonuc-box').style.display = 'block';
            }
        }

        function calcAltin() {
            let miktar = document.getElementById('calc-altin-miktar').value;
            let tur = document.getElementById('calc-altin-turu').value;
            let el = document.getElementById('val-' + tur);

            if (miktar && el) {
                let fiyat = temizleVeSayiyaCevir(el.textContent);
                if (fiyat === 0) {
                    alert("Piyasa verileri y√ºkleniyor, l√ºtfen 1-2 saniye bekleyip tekrar deneyin.");
                    return;
                }
                let sonuc = miktar * fiyat;
                let birimText = (tur === "GRAM") ? " Gram" : " Adet";
                document.getElementById('altin-sonuc-text').innerText =
                    miktar + birimText + " = " +
                    sonuc.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + " TL";
                document.getElementById('altin-sonuc-box').style.display = 'block';
            }
        }

        function guncelle() {
            fetch('/api/fiyatlar')
                .then(r => r.json())
                .then(data => {
                    const veriler = {...data.kurlar, ...data.altin};

                    Object.keys(veriler).forEach(key => {
                        let el = document.getElementById('val-' + key);
                        if(el) {
                            let yeniFiyatStr = veriler[key];
                            if(yeniFiyatStr === "---") return;

                            let yeniFiyatNum = temizleVeSayiyaCevir(yeniFiyatStr);

                            if (!(key in eskiFiyatlar)) {
                                eskiFiyatlar[key] = yeniFiyatNum;
                            }

                            let eskiFiyatNum = eskiFiyatlar[key];

                            if (!el.closest('#gizli-depo')) {
                                let ok = "";
                                el.classList.remove('price-up', 'price-down');

                                if (yeniFiyatNum > eskiFiyatNum) {
                                    ok = ' ‚ñ≤';
                                    el.classList.add('price-up');
                                } else if (yeniFiyatNum < eskiFiyatNum) {
                                    ok = ' ‚ñº';
                                    el.classList.add('price-down');
                                }

                                let dolarMi = (key === 'ONS' || key === 'ONS-GUMUS');
                                let birimSembol = dolarMi ? "" : " ‚Ç∫";
                                let gosterilecekMetin =
                                    (dolarMi ? "$" : "") + yeniFiyatStr + birimSembol;

                                el.innerHTML = gosterilecekMetin + ok;

                                if (yeniFiyatNum !== eskiFiyatNum) {
                                    el.classList.add('update-flash');
                                    setTimeout(() => el.classList.remove('update-flash'), 1000);
                                }
                            } else {
                                el.textContent = yeniFiyatStr;
                            }

                            eskiFiyatlar[key] = yeniFiyatNum;
                        }
                    });
                })
                .catch(err => console.error("Veri √ßekme hatasƒ±:", err));
        }

        guncelle();
        setInterval(guncelle, 4500);
    </script>
</body>
</html>